# 数据库日志管理实验

**预期阅读代码：**150行  		**非附加任务预期代码：**100行   		**附加任务预期代码：**40行

## 实验背景和目的

数据库管理系统通常会采用一些复杂的机制以确保在各种情况下数据不丢失且保持一致性。本次实验聚焦于实现一个简化的数据库日志管理系统，模拟数据库事务的处理过程以及日志的记录和恢复，帮助理解数据库事务和日志管理的基本原理。

假设我们正在开发一个简单的内存数据库系统，该系统主要用于存储键值对（key - value）数据。为了确保数据库在各种异常情况下的数据完整性，我们需要实现以下几个关键功能：

1. **数据库事务管理**：本实验不涉及并发事务。在一个事务中用户会执行一系列的操作（插入、更新、删除数据），这些操作需要作为一个原子操作来处理，即要么全部成功（提交事务），要么全部失败（回滚事务）。
2. **写前日志（WAL）机制**：写前日志（Write - Ahead Logging，WAL）是一种常用的数据库日志策略，用于确保在数据写入磁盘之前，先将相关的日志记录写入磁盘。本实验日志是内存日志，无需考虑磁盘持久化。
3. **事务恢复**：在系统崩溃后，需要能够利用日志文件进行数据恢复，以确保数据库的数据一致性。
4. （附加）**事务保存点**：保存点（Savepoint）是一个在事务执行过程中设置的标记点。在事务的部分失败时，可以回滚到保存点而不是完全回滚整个事务。





## 实验代码架构

**Database类**

简单的内存数据库，用于存储 `key-value` 数据，涉及数据变更时需要调用其内部方法。

**Operation类**

表示事务中的单个操作，本次实验支持`INSERT`、`UPDATE`、`DELETE`操作。一个事务会涉及一个或多个操作。

**WAL类**

简单的写前日志管理，将不同类型操作记录到日志中。

**Transaction类**

处理事务中各个操作的执行以及事物的执行与回滚，并管理事务的保存点。

**LogFile**

RedoLog、UndoLog分别是一条redo/undo日志记录，而RedoLogFile、UndoLogFile作为redo/undo日志的抽象化，充当日志文件角色，持有各自日志记录的集合。

对于Undo日志记录，一条记录包含4个字段，即transactionId(该记录对应的事务ID)、operationType(操作类型)、key(操作的键值)、oldValue(操作发生前的键对应的原值)。例如对于事务T1中的一次INSERT操作，该操作插入{"key1":"value1"}的键值对，则该次操作对应的Undo日志记录内容为：transactionId=T1,operationType="INSERT",key="key1",oldValue="null"。

**test**

提供了12个测试用例。



## 实验任务

1. 实现Transaction类中的**execute**方法。该方法代表事务中单个操作的执行，你需要实现INSERT、UPDATE、DELETE三种类型操作，先通过WAL中的相应方法将操作记录到Redo、Undo日志中，而后在Database类中进行数据变更。
2. 实现Transaction类中的**rollback**方法。处理事务的回滚，你需要利用WAL获取所需要的Undo日志记录并进行回滚。
3. 实现WAL类中的**recover**方法。该方法模拟在系统崩溃情况下利用redo日志进行数据恢复的操作。
4. （附加）实现保存点管理和回滚到保存点。你需要实现Transaction类中的**setSavepoint**和**rollbackToSavepoint**方法。前者是设置一个保存点，你需要在此过程中自行设计数据结构以存储savepoint。后者是在事务中回滚到离当前最近的一个保存点。



## 实验评分

满分：100

本次试验共提供12个测试用例，其中前10个涉及任务1、2、3，每个占10分。

最后两个涉及保存点功能，为附加题，可加分。



## 实验提交方式

请打包提交源码和在test下运行**TransactionTest**测试的结果截图，截图必须展示**一次性**运行测试文件中所有用例的结果。



## 注意事项与提示

1. 本次试验不涉及并发，且仅涉及INSERT、UPDATE、DELETE三种操作。
2. 执行DELETE操作时需要将对应的键值对删除而不是仅仅将value设为null，对INSERT操作的回滚亦然。
3. 事务只有在回滚或提交后才会结束活动状态，仅仅保存点回滚不会结束。
4. 请仔细阅读日志和日志文件类，其中RedoLogFile类中的addInitial方法代表redo日志存在初始记录。
5. 不知如何下手可以参考一下测试用例，推荐先实现**execute**方法和**recover**方法。

